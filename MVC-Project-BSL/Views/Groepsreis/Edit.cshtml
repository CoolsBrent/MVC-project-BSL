@using System.Globalization
@model MVC_Project_BSL.Models.Groepsreis

@{
    ViewBag.Title = "Bewerk Groepsreis";
}

<h2>Bewerk Groepsreis</h2>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    @if (ViewData.ModelState.ErrorCount > 0)
    {
        <div class="alert alert-warning">
            Let op: Als u vergeten bent iets in te vullen, moet u het bestand opnieuw selecteren.
        </div>
    }


    <input type="hidden" asp-for="Id" />

    <div class="form-group">
        <label asp-for="Begindatum" class="control-label"></label>
        <input asp-for="Begindatum" class="form-control" />
        <span asp-validation-for="Begindatum" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Einddatum" class="control-label"></label>
        <input asp-for="Einddatum" class="form-control" />
        <span asp-validation-for="Einddatum" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Prijs" class="control-label"></label>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">€</span>
            </div>
            <input asp-for="Prijs" class="form-control" type="number" step="1" />
        </div>
        <span asp-validation-for="Prijs" class="text-danger"></span>
    </div>


    <div class="form-group">
        <label asp-for="BestemmingId" class="control-label">Bestemming</label>
        <select asp-for="BestemmingId" asp-items="ViewBag.Bestemmingen" class="form-control"></select>
        <span asp-validation-for="BestemmingId" class="text-danger"></span>
    </div>

    <!-- Onkosten Sectie -->
    <h3>Onkosten</h3>

    @if (Model.Onkosten != null && Model.Onkosten.Any())
    {
        <table class="table" id="onkostenTable">
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Omschrijving</th>
                    <th>Bedrag</th>
                    <th>Datum</th>
                    <th>Foto</th>
                    <th>Acties</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Onkosten.Count; i++)
                {
                    <tr>
                        <td>
                            @Html.TextBoxFor(m => m.Onkosten[i].Titel, new { @class = "form-control autocomplete", data_index = i })
                            <span asp-validation-for="Onkosten[@i].Titel" class="text-danger"></span>
                        </td>


                        <td>
                            @Html.TextBoxFor(m => m.Onkosten[i].Omschrijving, new { @class = "form-control" })
                            <span asp-validation-for="Onkosten[@i].Omschrijving" class="text-danger"></span>
                        </td>
                        <td>
                            <div class="row align-items-center ms-2">
                                <span class="input-group-text col-auto">€</span>
                                <div class="col ml-0 p-0">
                                    @Html.TextBoxFor(m => m.Onkosten[i].Bedrag, new { @class = "form-control", type = "number", step = "0.01" })
                                </div>
                                <span asp-validation-for="Onkosten[@i].Bedrag" class="text-danger col-auto"></span>
                            </div>
                        </td>
                        <td>
                            @Html.TextBoxFor(m => m.Onkosten[i].Datum, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                            <span asp-validation-for="Onkosten[@i].Datum" class="text-danger"></span>
                        </td>
                        <td>
                            <input type="file" class="form-control" name="Onkosten[@i].FotoFile" data-val="true" data-val-requiredifnofoto="Het uploaden van een foto is verplicht." data-foto="@Model.Onkosten[i].Foto" />
                            <span asp-validation-for="Onkosten[@i].FotoFile" class="text-danger"></span>
                            @if (!string.IsNullOrEmpty(Model.Onkosten[i].Foto))
                            {
                                <img src="@Model.Onkosten[i].Foto" alt="Huidige Foto" style="max-width:100px;" />
                            }
                            @Html.HiddenFor(m => m.Onkosten[i].Foto)
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-onkost">Verwijderen</button>
                        </td>

                        <!-- Hidden fields -->
                        @Html.HiddenFor(m => m.Onkosten[i].Id)
                        @Html.HiddenFor(m => m.Onkosten[i].GroepsreisId)
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>Er zijn nog geen onkosten toegevoegd.</p>
        <table class="table" id="onkostenTable">
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Omschrijving</th>
                    <th>Bedrag</th>
                    <th>Datum</th>
                    <th>Foto</th>
                    <th>Acties</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    }

    <!-- Voeg nieuwe onkost toe -->
    <button type="button" class="btn btn-primary" id="btnAddOnkost">Voeg onkost toe</button>

    <!-- Totaal onkosten -->
    <p><strong>Totaal Onkosten:</strong> @(Model.Onkosten?.Sum(o => o.Bedrag).ToString("C", new CultureInfo("nl-BE")) ?? "€ 0,00")</p>

    <div class="form-group mt-2">
        <input type="submit" value="Opslaan" class="btn btn-primary" />
        <a asp-action="Index" class="btn btn-secondary">Annuleren</a>
    </div>

</form>

@section Scripts {


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />


    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        $(document).ready(function () {
            // Voeg de custom validator toe
            $.validator.addMethod("requiredifnofoto", function (value, element, parameters) {
                var foto = $(element).data("foto");
                if (!foto) {
                    return value && value.length > 0;
                }
                return true;
            });

            $.validator.unobtrusive.adapters.add("requiredifnofoto", [], function (options) {
                options.rules["requiredifnofoto"] = {};
                options.messages["requiredifnofoto"] = options.message;
            });

            var onkostenCounter = @Model.Onkosten?.Count() ?? 0;

            // Voeg nieuwe onkost toe
            $('#btnAddOnkost').click(function () {
                var index = onkostenCounter++;
                var newRow = '<tr>' +
                    '<td><input class="form-control autocomplete" name="Onkosten[' + index + '].Titel" />' +
                    '<span class="text-danger field-validation-valid" data-valmsg-for="Onkosten[' + index + '].Titel" data-valmsg-replace="true"></span></td>' +
                    '<td><input class="form-control" name="Onkosten[' + index + '].Omschrijving" />' +
                    '<span class="text-danger field-validation-valid" data-valmsg-for="Onkosten[' + index + '].Omschrijving" data-valmsg-replace="true"></span></td>' +
                    '<td><input class="form-control" type="number" step="1" name="Onkosten[' + index + '].Bedrag" />' +
                    '<span class="text-danger field-validation-valid" data-valmsg-for="Onkosten[' + index + '].Bedrag" data-valmsg-replace="true"></span></td>' +
                    '<td><input class="form-control" type="date" name="Onkosten[' + index + '].Datum" />' +
                    '<span class="text-danger field-validation-valid" data-valmsg-for="Onkosten[' + index + '].Datum" data-valmsg-replace="true"></span></td>' +
                    '<td><input type="file" class="form-control" name="Onkosten[' + index + '].FotoFile" data-val="true" data-val-requiredifnofoto="Het uploaden van een foto is verplicht." data-foto="" />' +
                    '<span class="text-danger field-validation-valid" data-valmsg-for="Onkosten[' + index + '].FotoFile" data-valmsg-replace="true"></span></td>' +
                    '<td><button type="button" class="btn btn-danger remove-onkost">Verwijderen</button></td>' +
                    '<input type="hidden" name="Onkosten[' + index + '].GroepsreisId" value="@Model.Id" />' +
                    '</tr>';
                $('#onkostenTable tbody').append(newRow);

                // Re-initialiseer de validatie voor de nieuw toegevoegde elementen
                $.validator.unobtrusive.parse('#onkostenTable');

                // Initialiseer autocomplete voor de nieuwe titelvelden
                initializeAutocomplete();
            });

            // Verwijder onkost
            $(document).on('click', '.remove-onkost', function () {
                $(this).closest('tr').remove();
            });

            // Functie voor autocomplete
            function initializeAutocomplete() {
                $('.autocomplete').autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: '@Url.Action("GetOnkosten", "Groepsreis")', // De actie in je controller
                            dataType: "json",
                            data: {
                                term: request.term // De zoekterm die je invoert
                            },
                            success: function (data) {
                                response(data); // Geef de zoekresultaten terug
                            },
                            error: function () {
                                response([]); // Lege lijst teruggeven bij fout
                            }
                        });
                    },
                    minLength: 0, // Start zoekopdracht zonder minimaal aantal tekens
                    select: function (event, ui) {
                        $(this).val(ui.item.value); // Vul het tekstveld met de geselecteerde waarde
                        return false; // Voorkom dat het automatisch invult bij hover
                    },
                    open: function () {
                        // Eventueel kun je hier extra logica toevoegen, bijvoorbeeld styling voor de lijst
                    }
                });

                // Trigger autocomplete direct als je op het tekstvak klikt (zonder zoekterm)
                $(document).on('focus', '.autocomplete', function () {
                    $(this).autocomplete("search", ""); // Start de zoekfunctie met een lege zoekterm
                });
            }

            // Initialiseer autocomplete voor al bestaande velden
            initializeAutocomplete();
        });


    </script> 

}
